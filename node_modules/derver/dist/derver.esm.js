var ge=Object.create;var L=Object.defineProperty;var we=Object.getOwnPropertyDescriptor;var ye=Object.getOwnPropertyNames;var xe=Object.getPrototypeOf,be=Object.prototype.hasOwnProperty;var Ee=e=>L(e,"__esModule",{value:!0});var h=e=>{if(typeof require!="undefined")return require(e);throw new Error('Dynamic require of "'+e+'" is not supported')};var j=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var Se=(e,t,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of ye(t))!be.call(e,i)&&i!=="default"&&L(e,i,{get:()=>t[i],enumerable:!(r=we(t,i))||r.enumerable});return e},Ce=e=>Se(Ee(L(e!=null?ge(xe(e)):{},"default",e&&e.__esModule&&"default"in e?{get:()=>e.default,enumerable:!0}:{value:e,enumerable:!0})),e);var P=j((At,q)=>{var C=h("fs"),Z=h("path"),tt=h("os");function $(e,t){return Object.prototype.toString.call(e)==="[object "+t+"]"}function D(e,t){try{return t(e)}catch(r){if(/^(ENOENT|EPERM|EACCES)$/.test(r.code))return r.code!=="ENOENT"&&console.warn("Warning: Cannot access %s",e),!1;throw r}}var rt={nil:function(e){return e==null},array:function(e){return Array.isArray(e)},emptyObject:function(e){for(var t in e)return!1;return!0},buffer:function(e){return Buffer.isBuffer(e)},regExp:function(e){return $(e,"RegExp")},string:function(e){return $(e,"String")},func:function(e){return typeof e=="function"},number:function(e){return $(e,"Number")},exists:function(e){return C.existsSync(e)},file:function(e){return D(e,function(t){return C.statSync(t).isFile()})},samePath:function(e,t){return Z.resolve(e)===Z.resolve(t)},directory:function(e){return D(e,function(t){return C.statSync(t).isDirectory()})},symbolicLink:function(e){return D(e,function(t){return C.lstatSync(t).isSymbolicLink()})},windows:function(){return tt.platform()==="win32"}};q.exports=rt});var ie=j((It,ne)=>{var x=h("fs"),ee=h("os"),_=h("path"),R=P(),b,nt=ee.tmpdir&&ee.tmpdir()||process.env.TMPDIR||process.env.TEMP||process.cwd();function te(){this.stack=[]}te.prototype={create:function(e,t){var r=_.join(t,"node-watch-"+Math.random().toString(16).substr(2));return this.stack.push({name:r,type:e}),r},write:function(){for(var e=0;e<arguments.length;++e)x.writeFileSync(arguments[e]," ")},mkdir:function(){for(var e=0;e<arguments.length;++e)x.mkdirSync(arguments[e])},cleanup:function(e){try{for(var t;t=this.stack.pop();){var r=t.type,i=t.name;r==="file"&&R.file(i)?x.unlinkSync(i):r==="dir"&&R.directory(i)&&x.rmdirSync(i)}}finally{R.func(e)&&e()}}};var re=!1;ne.exports=function e(t){if(!R.func(t))return!1;if(b!==void 0)return t(b);if(!re)re=!0;else return setTimeout(function(){e(t)},300);var r=new te,i=r.create("dir",nt),n=r.create("dir",i),o=r.create("file",n);r.mkdir(i,n);var a={recursive:!0},c;try{c=x.watch(i,a)}catch(u){if(u.code=="ERR_FEATURE_UNAVAILABLE_ON_PLATFORM")return t(b=!1);throw u}if(!c)return!1;var s=setTimeout(function(){c.close(),r.cleanup(function(){t(b=!1)})},200);c.on("change",function(u,d){_.basename(o)===_.basename(d)&&(c.close(),clearTimeout(s),r.cleanup(function(){t(b=!0)}))}),r.write(o)}});var he=j((Ft,F)=>{var W=h("fs"),E=h("path"),oe=h("util"),ae=h("events"),ce=ie(),l=P(),it="update",se="remove",O=Symbol("skip");function ot(e){return e.some(function(t,r,i){return i.indexOf(t)!==r})}function A(e){return e.filter(function(t,r,i){return i.indexOf(t)===r})}function at(e){return e.reduce(function(t,r){return t.concat(r)},[])}function ct(e){if(e&&e!=="buffer"&&!Buffer.isEncoding(e))throw new Error("Unknown encoding: "+e)}function st(e){return function(t,r){if(l.func(e)){var i=e(t,O);i&&i!==O&&r()}else l.regExp(e)?e.test(t)&&r():r()}}function lt(e){return e.map(function(t){return l.exists(t)?[it,t]:[se,t]})}function ut(e){var t=A(e),r=/~$|^\.#|^##$/g,i=e.some(function(o){return r.test(o)});if(i){var n=ot(e.map(function(o){return o.replace(r,"")}));n&&(t=t.filter(function(o){return l.exists(o)}))}return lt(t)}function ft(e,t){var r,i=[],n=e.options.encoding,o=e.options.delay;l.number(o)||(o=200);function a(){ut(i).forEach(function(c){c[1]=Buffer.from(c[1]),n!=="buffer"&&(c[1]=c[1].toString(n)),t.apply(null,c)}),r=null,i=[]}return function(c,s){i.push(s),r||(r=setTimeout(a,o))}}function le(){var e={};return function(t){return function(r,i){e[r+i]=[r,i],setTimeout(function(){Object.keys(e).forEach(function(n){t.apply(null,e[n])}),e={}})}}}function ue(e,t,r=function(){}){l.directory(e)?W.readdir(e,function(i,n){if(i)if(/^(EPERM|EACCES)$/.test(i.code))console.warn("Warning: Cannot access %s.",e);else throw i;else n.forEach(function(o){var a=E.join(e,o);l.directory(a)&&t(a)}),r()}):r()}function dt(e){var t=0;return function(){return t++,function(){t--,t===0&&e()}}}function mt(){return function(){}}function fe(e,t){return!l.func(t)||t(e,O)!==O}var de=oe.deprecate(function(){},"(node-watch) First param in callback function  is replaced with event name since 0.5.0, use  `(evt, filename) => {}` if you want to get the filename");function p(){ae.EventEmitter.call(this),this.watchers={},this._isReady=!1,this._isClosed=!1}oe.inherits(p,ae.EventEmitter);p.prototype.expose=function(){var e={},t=this,r=["on","emit","once","close","isClosed","listeners","setMaxListeners","getMaxListeners","getWatchedPaths"];return r.forEach(function(i){e[i]=function(){return t[i].apply(t,arguments)}}),e};p.prototype.isClosed=function(){return this._isClosed};p.prototype.close=function(e){var t=this;if(e){var r=this.watchers[e];r&&r.close&&(r.close(),delete t.watchers[e]),ue(e,function(i){t.close(i)})}else Object.keys(t.watchers).forEach(function(i){var n=t.watchers[i];n&&n.close&&n.close()}),this.watchers={};l.emptyObject(t.watchers)&&(this._isClosed||(this._isClosed=!0,process.nextTick(me,this)))};p.prototype.getWatchedPaths=function(e){if(l.func(e)){var t=this;t._isReady?e(Object.keys(t.watchers)):t.on("ready",function(){e(Object.keys(t.watchers))})}};function I(e){e._isReady||(e._isReady=!0,process.nextTick(function(){e.emit("ready")}))}function me(e){e.emit("close")}p.prototype.add=function(e,t){var r=this;t=t||{fpath:""};var i=E.resolve(t.fpath);this.watchers[i]=e;var n=function(a,c){if(!r.isClosed()){var s=c;l.nil(s)&&(s=""),s=E.join(t.fpath,s),t.options.recursive&&ce(function(u){if(!u){var d=E.resolve(s);if(!l.exists(s))r.close(d);else{var w=l.directory(s)&&!r.watchers[d]&&fe(s,t.options.filter);w&&r.watchDirectory(s,t.options)}}}),o(a,s)}},o=ft(t,function(a,c){if(t.compareName)t.compareName(c)&&r.emit("change",a,c);else{var s=st(t.options.filter);s(c,function(){r.flag?r.flag="":r.emit("change",a,c)})}});e.on("error",function(a){r.isClosed()||(l.windows()&&a.code==="EPERM"?(e.emit("change",se,t.fpath&&""),r.flag="windows-error",r.close(i)):r.emit("error",a))}),e.on("change",n)};p.prototype.watchFile=function(e,t,r){var i=E.join(e,"../"),n=Object.assign({},t,{filter:null,encoding:"utf8"});delete n.recursive;var o=W.watch(i,n);this.add(o,{type:"file",fpath:i,options:Object.assign({},n,{encoding:t.encoding}),compareName:function(a){return l.samePath(a,e)}}),l.func(r)&&(r.length===1&&de(),this.on("change",r))};p.prototype.watchDirectory=function(e,t,r,i=mt){var n=this,o=i();ce(function(a){t.recursive=!!t.recursive;var c=Object.assign({},t,{encoding:"utf8"});if(a||delete c.recursive,n._isClosed)return o(),n.close();var s=W.watch(e,c);n.add(s,{type:"dir",fpath:e,options:t}),l.func(r)&&(r.length===1&&de(),n.on("change",r)),t.recursive&&!a&&ue(e,function(u){fe(u,t.filter)&&n.watchDirectory(u,t,null,i)},i()),o()})};function ht(e){var t=new p,r=le(),i=e.length;return e.forEach(function(n){n.on("change",r(function(o,a){t.emit("change",o,a)})),n.on("error",function(o){t.emit("error",o)}),n.on("ready",function(){--i||I(t)})}),t.close=function(){e.forEach(function(n){n.close()}),process.nextTick(me,t)},t.getWatchedPaths=function(n){if(l.func(n)){var o=e.map(function(a){return new Promise(function(c){a.getWatchedPaths(c)})});Promise.all(o).then(function(a){var c=A(at(a));n(c)})}},t.expose()}function T(e,t,r){var i=new p;if(l.buffer(e)&&(e=e.toString()),!l.array(e)&&!l.exists(e)&&i.emit("error",new Error(e+" does not exist.")),l.string(t)&&(t={encoding:t}),l.func(t)&&(r=t,t={}),arguments.length<2&&(t={}),t.encoding?ct(t.encoding):t.encoding="utf8",l.array(e)){if(e.length===1)return T(e[0],t,r);var n=le();return ht(A(e).map(function(a){var c=T(a,t);return l.func(r)&&c.on("change",n(r)),c}))}if(l.file(e))i.watchFile(e,t,r),I(i);else if(l.directory(e)){var o=dt(function(){I(i)});i.watchDirectory(e,t,r,o)}return i.expose()}F.exports=T;F.exports.default=T});import ze from"http";import S from"fs/promises";import Be from"os";import g from"path";import V from"zlib";var Re="text/html",Oe="text/html",Te="image/jpeg",Ne="image/jpeg",Le="image/gif",je="image/png",ke="image/svg+xml",Me="text/javascript",$e="application/json",De="text/css",Pe="image/x-icon",k={".htm":Re,".html":Oe,".jpg":Te,".jpeg":Ne,".gif":Le,".png":je,".svg":ke,".js":Me,".json":$e,".css":De,".ico":Pe};var v=(e,t,r)=>`[${t}m${e}[${r}m`,f={blue:e=>v(e,34,39),red:e=>v(e,31,39),green:e=>v(e,32,39),yellow:e=>v(e,33,39),magenta:e=>v(e,35,39),cyan:e=>v(e,36,39),gray:e=>v(e,90,39),bold:e=>v(e,1,22),italic:e=>v(e,3,23)};function U(){let e=2,t=[],r={line:(i="",n,o)=>{let a=i.length;return a+2>e&&(e=a+2),n&&(i=f[n](i)),o&&(i=f[o](i)),t.push([i,a]),r},print:(i=0,n)=>{let o=" ".repeat(i),a=`${o}\u2554${"\u2550".repeat(e)}\u2557`,c=`${o}\u255A${"\u2550".repeat(e)}\u255D`,s=`${o}\u2551`,u="\u2551";n&&(a=f[n](a),c=f[n](c),s=f[n](s),u=f[n](u)),console.log(a);for(let d of t){let w=Math.floor((e-d[1])/2),N=e-d[1]-w;console.log(`${s}${" ".repeat(w)}${d[0]}${" ".repeat(N)}${u}`)}return console.log(c),r}};return r}import _e from"http";import We from"os";import Ae from"path";import H from"fs";var z="/derver-livereload-events",B="/derver-livereload-remote",M=new Set;function y(e,t,r){M.forEach(i=>{typeof i[e]=="function"&&i[e](t,r)})}function Ie(e){let t=typeof e=="string"?e:!1,r="localhost",i=7e3;t||(e&&e.host&&(r=e.host),e&&e.port&&(i=e.port));function n(o,a){return new Promise(c=>{let s=t&&Ue(t);s&&s.host&&(hostname=s.host),s&&s.port&&(i=s.port);let u={hostname:s&&s.host||r,port:s&&s.port||i,path:B,method:"POST",headers:{"Content-Type":"application/json"}},d=_e.request(u,w=>{w.on("data",N=>{N.toString()==="REMOTE OK"?c("OK"):(console.log("[Derver remote]: Warning: wrong command "+o),c("WARNING"))})});d.on("error",w=>{console.log("[Derver remote]: Warning:"+w.message),c("WARNING")}),d.write(JSON.stringify({command:o,data:a||{}})),d.end()})}return{reload(){return n("reload")},console(o){return n("console",{text:o})},error(o,a){return n("error",{text:o,header:a})}}}function G(e){return!e.watch&&!e.remote?null:function(t,r,i){if(t.url==z){let n=(a,c)=>r.write(`event: ${a}
data: ${JSON.stringify(c||{})}

`),o={reload:()=>n("refresh"),console:a=>n("console",{text:a}),error:(a,c)=>n("srverror",{text:a,header:c||"Error"})};M.add(o),r.writeHead(200,{"Content-Type":"text/event-stream","Cache-Control":"no-cache",Connection:"keep-alive"}),r.on("close",function(){M.delete(o)}),r.write(`data: connected

`)}else if(e.remote&&t.url==B)if(t.method=="POST"){let n="";t.on("data",o=>{n+=o.toString()}),t.on("end",()=>{let o=JSON.parse(n||"{}");if(o.command=="reload")y("reload");else if(o.command=="console")y("console",o.data.text);else if(o.command=="error")y("error",o.data.text,o.data.header);else return r.end("REMOTE WRONG COMMAND");r.end("REMOTE OK")})}else i();else i()}}function Fe(){return function(e){let t;function r(){if(window.EventSource){let o=function(a){return JSON.parse(a.data)};var n=new EventSource(e);n.addEventListener("refresh",function(a){location.reload()},!1),n.addEventListener("console",function(a){console.log(o(a).text)},!1),n.addEventListener("srverror",function(a){let c=o(a);i(c.header,c.text)},!1),n.addEventListener("open",function(a){t&&location.reload(),console.log("[Livereload] Ready")},!1),n.addEventListener("error",function(a){a.eventPhase==EventSource.CLOSED&&n.close(),a.target.readyState==EventSource.CLOSED?(console.log("[Livereload] Disconnected! Retry in 5s..."),!t&&i("Disconnected!","Connection with server was lost."),t=setTimeout(r,5e3)):a.target.readyState==EventSource.CONNECTING&&console.log("[Livereload] Connecting...")},!1)}else console.error("[Livereload] Can't start Livereload! Your browser doesn't support SSE")}function i(n,o){let a=document.createElement("div");a.innerHTML=`
                  <div class="lrmsg-bg">
                    <div class="lrmsg-modal">
                      <div class="lrmsg-close" onclick="this.parentNode.parentNode.remove()">\xD7</div>
                      <div class="lrmsg-header">${n}</div>
                      <div class="lrmsg-content">${o}</div>
                    </div>
                  </div>
                  <style>
                    .lrmsg-bg{
                      font-family: Verdana, Geneva, sans-serif;
                      font-size: 16px;
                      background: rgba(30, 30, 30, 0.6);
                      position: fixed;
                      top: 0;
                      right: 0;
                      bottom: 0;
                      left: 0;
                      z-index: 1;
                    }

                    .lrmsg-modal{
                      position: relative;
                      max-width: 600px;
                      max-height: 400px;
                      margin: 40px auto; 
                      margin-top: 0px;
                      background-color: #1e1e1e;
                      border-top: 3px solid red;
                      border-radius: 5px;
                      opacity: 0;
                      animation: slide 0.3s forwards;
                      color: #cccccc;
                    }

                    .lrmsg-header{
                      font-weight: bold;
                      font-size: 18px;
                      padding: 10px;
                    }

                    .lrmsg-close{
                      float: right;
                      font-weight: bold;
                      color: #cccccc;
                      font-size: 25px;
                      margin: 3px 10px;
                      cursor: pointer;
                    }

                    .lrmsg-close:hover{color:#9a9a9a}

                    .lrmsg-content{
                      padding: 10px;
                      border-top: 1px solid #363636;
                    }

                    @keyframes slide {
                      100% { margin-top: 40px; opacity: 1;}
                  }
                  </style>
                `,document.body.append(a)}r()}.toString()}function J(e){return!e.watch&&!e.remote?null:function(t,r,i){[".html",".htm"].includes(t.extname)&&(r.body=Buffer.from(r.body.toString("utf-8").replace(/(<\/body>)/,`<script>(${Fe()})('${z}')<\/script>
$1`))),i()}}function Ue(e){let t=We.tmpdir(),r=Ae.join(t,"derver_"+e);return H.existsSync(r)?JSON.parse(H.readFileSync(r,"utf-8")):!1}var K="0.4.16";function Y(e){let t=e.watch===!1&&e.cache&&e.compress;return new Promise(async(r,i)=>{let n=await et(e),o=ze.createServer(function(c,s){Ge([Je(e),Ve(e),Ye(e),...e.middlewares.list(),G(e),Ke(e),Qe(e),J(e),Xe(e),Ze(e)],c,s)});o.on("listening",c=>{r(o),U().line(t?"Derver server started":"Development server started","bold").line("on").line(`http://${e.host}:${e.port}`,"blue").print(5,"green")}),o.on("error",c=>{console.log(f.bold(`

Server starting error:`)),console.log("  "+f.red(c.toString())+`

`),i(c.toString())}),o.listen(e.port,e.host);let a=async()=>{await n(),o.close()};process.on("SIGTERM",a),process.on("exit",a)})}function Q(){let e=[];function t(n){for(let o of n.middlewares)e.push(function(a,c,s){if(n.method&&n.method!==a.method)return s();if(n.pattern&&n.pattern!==""){let u=qe(n.pattern,a.path);if(!u||n.exact&&!u.exact)return s();a.params=u.params}o(a,c,s)})}function r(n,o,a){n=Array.from(n);let c=n.length>0&&typeof n[0]=="string"?n.shift():null;return c&&!c.startsWith("/")&&(c="/"+c),{method:o=="use"?null:o.toUpperCase(),pattern:(a||"")+(c||""),exact:!(a&&!c),middlewares:n.filter(s=>typeof s=="function")}}function i(n){let o=new Proxy({},{get(a,c){return c=="list"?()=>e:c=="sub"?function(){let s=Array.from(arguments),u=(n||"")+s.shift();s.forEach(d=>d(i(u)))}:function(){return t(r(arguments,c,n)),o}}});return o}return i()}function Ge(e,t,r){e.push((n,o)=>o.send(o.body||""));let i=()=>{let n;for(;!n&&e.length>0;)n=e.shift();n&&n(t,r,i)};i()}function Je(e){return function(t,r,i){let n=new URL(t.url,"http://"+(t.headers.host||"derver.tld"));t.path=n.pathname,t.host=n.host,t.hostname=n.hostname,t.port=n.port,t.search=n.search,t.query=Array.from(n.searchParams).reduce((o,[a,c])=>(o[a]=c,o),{}),i()}}function Ke(e){return async function(t,r,i){if(t.file=g.join(e.dir,t.path),t.extname=g.extname(t.file),t.extname===""&&(t.file=g.join(t.file,e.index),t.extname=g.extname(t.file)),t.exists=await X(t.file),e.spa&&!t.exists&&t.extname===g.extname(e.index)){console.log();let n=g.dirname(t.file);do if(n=g.dirname(n),t.file=g.join(n,e.index),t.exists=await X(t.file))break;while(n!==".")}i()}}function Ve(e){return function(t,r,i){r.send=function(n){r.writeHead(200),r.end(n)},i()}}function Ye(e){return function(t,r,i){r.setHeader("Server","Derver/"+K),i()}}function Qe(e){return async function(t,r,i){if(!t.exists)return console.log(f.gray("  [web] ")+t.url+" - "+f.red("404 Not Found")),r.writeHead(404,{"Content-Type":"text/plain"}),r.end("Not found");k[t.extname]&&r.setHeader("Content-Type",k[t.extname]),r.body=await S.readFile(t.file),console.log(f.gray("  [web] ")+t.url+" - "+f.green("200 OK")),i()}}function Xe(e){return e.compress?function(t,r,i){t.headers["accept-encoding"]&&(t.headers["accept-encoding"].includes("br")?(r.setHeader("Content-Encoding","br"),r.body=V.brotliCompressSync(r.body)):t.headers["accept-encoding"].includes("gzip")&&(r.setHeader("Content-Encoding","gzip"),r.body=V.gzipSync(r.body))),i()}:null}function Ze(e){return e.cache?function(t,r,i){typeof e.cache!="number"&&(e.cache=31536e3),r.setHeader("Cache-Control","max-age="+e.cache),i()}:null}function qe(e,t){e=e.endsWith("/")?e:e+"/",t=t.endsWith("/")?t:t+"/";let r=[],i={},n=!0,o=e.split("/").map(c=>c.startsWith(":")?(r.push(c.slice(1)),"([^\\/]+)"):c).join("\\/"),a=t.match(new RegExp(`^${o}$`));return a||(n=!1,a=t.match(new RegExp(`^${o}`))),a?(r.forEach((c,s)=>i[c]=a[s+1]),{exact:n,params:i,part:a[0].slice(0,-1)}):null}async function et(e){let t=Be.tmpdir();if(typeof e.remote!="string")return()=>{};let r=g.join(t,"derver_"+e.remote);return await S.writeFile(r,JSON.stringify({host:e.host,port:e.port})),async()=>await S.unlink(r)}async function X(e){try{return await S.stat(e),!0}catch{return!1}}var pe=Ce(he());function ve(e){if(typeof e.watch=="string"&&(e.watch=[e.watch]),e.watch){console.log(f.yellow(`       Waiting for changes...

`));let t=[];process.on("SIGTERM",()=>t.forEach(n=>n.close())),process.on("exit",()=>t.forEach(n=>n.close()));let r=new Set,i=(n,o)=>{r.has(n)||(r.add(n),setTimeout(()=>r.delete(n),100),o())};for(let n of e.watch)t.push((0,pe.default)(n,{recursive:!0},async function(o,a){i(n,()=>console.log(f.gray("[watch] ")+"Changes in "+f.blue(n)));let c=!0;typeof e.onwatch=="function"&&await e.onwatch({prevent:()=>c=!1,reload:()=>y("reload"),console:s=>y("console",s),error:(s,u)=>y("error",s,u)},n,a,o),c&&y("reload")}))}}var pt={port:7e3,host:"localhost",index:"index.html",dir:"public",compress:!1,cache:!1,spa:!1,watch:null,onwatch:null,remote:!1};function Jt(e){let t=Object.assign(pt,e,{middlewares:Q()});return(async()=>{t.watch===null&&(t.watch=t.dir);try{await Y(t)}catch(r){console.log(r.message),process.exit(1)}ve(t)})(),t.middlewares}export{Ie as createRemote,Jt as derver};
